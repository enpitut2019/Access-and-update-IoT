<!-- モデル名 ”A" のバージョン変化を監視するhtml -->
<!DOCTYPE html>
<html>
    <head><meta http-equiv="content-type" charset="utf-8"></head>
    <body>
		<form name="Test_form" action="test.html">
        <div id="networkid"></div>
        <div id="accounts"></div>
        <div>現在のバージョン:&nbsp;<div id="id"></div> <br>
        プログラム↓<br>
		<div id="program"></div>
        <br>
        <!-- ブロックチェーンに保管されたハッシュ値をとって比較ではなく、ハッシュ値を送って等しいか比べるため、
        とって来る必要はないと考え、以下のコードはコメントアウトしている-->
		<!--ブロックチェーンに保管されたハッシュ値:&nbsp; <div id="bhash"></div><br>-->
		取得したファイルのハッシュ値:&nbsp; <div id="ghash"></div><br>
		等しいかどうか: &nbsp; <div id="eq"></div>
        </div>
		<script type="text/javascript" src="./jsSHA-master/src/sha256.js"></script>
		<script src="https://code.jquery.com/jquery-3.4.0.min.js"></script>
        <script>
            if (typeof web3 !== 'undefined') {
                web3 = new Web3(web3.currentProvider);
                ethereum.enable();

                const address = '0x4eec6e7e7109b3f0911fa009e4dbb58642702308';

                const abi =[
	{
		"constant": false,
		"inputs": [
			{
				"name": "phash",
				"type": "string"
			},
			{
				"name": "_model",
				"type": "string"
			}
		],
		"name": "upNewProgram",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_var",
				"type": "string"
			}
		],
		"name": "getHash",
		"outputs": [
			{
				"name": "",
				"type": "bytes32"
			}
		],
		"payable": false,
		"stateMutability": "pure",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_model",
				"type": "string"
			}
		],
		"name": "getVer",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_model",
				"type": "string"
			},
			{
				"name": "_id",
				"type": "uint256"
			}
		],
		"name": "getVerifier",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"name": "ver",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_hash",
				"type": "string"
			},
			{
				"name": "_model",
				"type": "string"
			}
		],
		"name": "verify",
		"outputs": [
			{
				"name": "",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	}
]
const address2 = '0x05fa2df3c059aabbd8bb925d5bd917edd55fcf10';
			const abi2 = [
	{
		"constant": false,
		"inputs": [
			{
				"name": "_model",
				"type": "string"
			},
			{
				"name": "_program",
				"type": "string"
			}
		],
		"name": "storeProgram",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_var",
				"type": "string"
			}
		],
		"name": "getHash",
		"outputs": [
			{
				"name": "",
				"type": "bytes32"
			}
		],
		"payable": false,
		"stateMutability": "pure",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_model",
				"type": "string"
			},
			{
				"name": "_id",
				"type": "uint256"
			}
		],
		"name": "getProgram",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "string"
			},
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "programs",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	}
]
				const mystrage = web3.eth.contract(abi2).at(address2);

				// コンストラクトのインスタンスを生成
                const mycontract = web3.eth.contract(abi).at(address);
				var account, id, program;

				// ハッシュ生成
				const HASH_KEY = 'HASH_KEY';
				function generateHash (text) {
 				   const sha256 = new jsSHA('SHA-256', 'TEXT');
 				   sha256.update(text + HASH_KEY);
 				   return sha256.getHash('HEX');
				}

				// アカウントおよびネットワークに関する情報を表示
				web3.version.getNetwork((error, result) => {
                    $('#networkid').text('Network ID: '+result)
                })
  
                web3.eth.getAccounts((error, result) => {
					account = result[0]
                    $('#accounts').text('Your accounts: '+account)
                })

                mycontract.getVer.call('A',{from: account, gas:3000000},(error, result) =>{
                    id = result;
					$('#id').text(result)
                });

                mystrage.getProgram.call('A',id-1,{from: account, gas:3000000},(error, result) =>{
                    program = result;
					$('#program').text(result)
                });

				// ページの更新
				function reloadFunctions(){
					// アカウント・お金の更新
					web3.eth.getAccounts((error, result) => {
						if (account != result[0]){
							location.reload();
						}
						account = result[0]
    	                $('#accounts').text('Your accounts: '+account)
                	});
                    mycontract.getVer.call('A',{from: account, gas:3000000},(error, result) =>{
                        if(id != result){
                            id = result;
                            $('#id').text(result)
							var ghash, bhash
                            mystrage.getProgram.call('A',id-1,{from: account, gas:3000000},(error2, result2) =>{
                                program = result2;
				            	$('#program').text(result2)
								ghash = generateHash(program)
								$('#ghash').text(ghash)
								mycontract.verify.call(ghash,'A', {from: account, gas:3000000}, (error3, result3) => {
									$('#eq').text(result3)
								})
                            });
                        }
                	});
				}

				setInterval('reloadFunctions()',100);
            } else {
                document.write('Install <a href="https://metamask.io">METAMASK</a>')
            }

			
		</script>
		</form>
    </body>
</html>