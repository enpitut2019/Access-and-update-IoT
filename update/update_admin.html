<!-- モデル名 ”A" のバージョン変化を監視するhtml -->
<!DOCTYPE html>
<html>
    <head><meta http-equiv="content-type" charset="utf-8"></head>
    <body>
		<form name="Test_form" action="test.html">
        <div id="networkid"></div>
        <div id="accounts"></div>
		<div>最新のアップデート情報:&nbsp;<div id="id"></div> 
		<div id="address">アドレス: </div><br>
        プログラム↓<br>
		<div id="program"></div>
        <br>
        <!-- ブロックチェーンに保管されたハッシュ値をとって比較ではなく、ハッシュ値を送って等しいか比べるため、
        とって来る必要はないと考え、以下のコードはコメントアウトしている-->
		<!--ブロックチェーンに保管されたハッシュ値:&nbsp; <div id="bhash"></div><br>-->
		取得したファイルのハッシュ値:&nbsp; <div id="ghash"></div><br>
		等しいかどうか: &nbsp; <div id="eq"></div>
		<div>モデルの最新のバージョンを取得</div>
		<input type="text" placeholder="string_model" name="get_ver"> &nbsp;&nbsp;  <input type="button" value="最新バージョンを取得" onclick="getVer()"><br>
		<div id="ver"></div>
        </div>
		<script type="text/javascript" src="./jsSHA-master/src/sha256.js"></script>
		<script src="https://code.jquery.com/jquery-3.4.0.min.js"></script>
        <script>
            if (typeof web3 !== 'undefined') {
                web3 = new Web3(web3.currentProvider);
                ethereum.enable();
                const address = '0x112738c1e8e69a86f7e24ddc97cbf15898e1a699';
                const abi =[
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "bytes32"
			}
		],
		"name": "ver",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_var",
				"type": "string"
			}
		],
		"name": "getHash",
		"outputs": [
			{
				"name": "",
				"type": "bytes32"
			}
		],
		"payable": false,
		"stateMutability": "pure",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_model",
				"type": "string"
			}
		],
		"name": "getVer",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_model",
				"type": "string"
			},
			{
				"name": "_id",
				"type": "uint256"
			}
		],
		"name": "getVerifier",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_model",
				"type": "string"
			}
		],
		"name": "badModel",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_hash",
				"type": "string"
			},
			{
				"name": "_model",
				"type": "string"
			}
		],
		"name": "verify",
		"outputs": [
			{
				"name": "",
				"type": "bool"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_models",
				"type": "bytes32[]"
			},
			{
				"name": "_states",
				"type": "uint8[]"
			}
		],
		"name": "getModelStates",
		"outputs": [
			{
				"name": "",
				"type": "uint8[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getUpInfo",
		"outputs": [
			{
				"name": "",
				"type": "string"
			},
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_model",
				"type": "string"
			}
		],
		"name": "safeModel",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "phash",
				"type": "string"
			},
			{
				"name": "_model",
				"type": "string"
			}
		],
		"name": "upNewProgram",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_model",
				"type": "string"
			}
		],
		"name": "getState",
		"outputs": [
			{
				"name": "",
				"type": "uint8"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "bytes32"
			}
		],
		"name": "model_state",
		"outputs": [
			{
				"name": "",
				"type": "uint8"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "up_model",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "constructor"
	}
]
const address2 = '0xf69113be8682d3eb3b603f51dab04c16f02fd9b3';
			const abi2 = [
	{
		"constant": false,
		"inputs": [
			{
				"name": "_model",
				"type": "string"
			},
			{
				"name": "_program",
				"type": "string"
			}
		],
		"name": "storeProgram",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_var",
				"type": "string"
			}
		],
		"name": "getHash",
		"outputs": [
			{
				"name": "",
				"type": "bytes32"
			}
		],
		"payable": false,
		"stateMutability": "pure",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_model",
				"type": "string"
			},
			{
				"name": "_id",
				"type": "uint256"
			}
		],
		"name": "getProgram",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "string"
			},
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "programs",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	}
]

				const address_admin = "0x5b2975eb771f20eafd8d6144860faa0358ccaa70";
				const abi_admin = [
	{
		"constant": false,
		"inputs": [
			{
				"name": "follower",
				"type": "address"
			}
		],
		"name": "addMember",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [],
		"name": "createGroup",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_inputs",
				"type": "uint8[]"
			}
		],
		"name": "isSecureList",
		"outputs": [
			{
				"name": "",
				"type": "uint8[]"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "follower",
				"type": "address"
			}
		],
		"name": "removeMember",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "admin",
				"type": "address"
			},
			{
				"name": "ownmodel",
				"type": "string"
			}
		],
		"name": "requestJoin",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "hashed",
				"type": "bytes32[]"
			},
			{
				"name": "goodbad",
				"type": "uint8[]"
			}
		],
		"name": "updateinfo",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"name": "_vender",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"name": "addrTomodel",
		"outputs": [
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getAllowedMembers",
		"outputs": [
			{
				"name": "",
				"type": "address[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getAuthenticatedMembers",
		"outputs": [
			{
				"name": "",
				"type": "address[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getDangerDevices",
		"outputs": [
			{
				"name": "",
				"type": "bytes32[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getGid",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_var",
				"type": "string"
			}
		],
		"name": "getHash",
		"outputs": [
			{
				"name": "",
				"type": "bytes32"
			}
		],
		"payable": false,
		"stateMutability": "pure",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_model",
				"type": "string"
			}
		],
		"name": "getIsSecure",
		"outputs": [
			{
				"name": "",
				"type": "uint8"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getModels",
		"outputs": [
			{
				"name": "",
				"type": "bytes32[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_model",
				"type": "string"
			}
		],
		"name": "getModeltoFollowers",
		"outputs": [
			{
				"name": "",
				"type": "address[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_adder",
				"type": "address"
			}
		],
		"name": "isSecureAdder",
		"outputs": [
			{
				"name": "",
				"type": "uint8"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_model",
				"type": "string"
			}
		],
		"name": "searchModel",
		"outputs": [
			{
				"name": "",
				"type": "address[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "ven",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	}
]
				// Storeのインスタンス
				const mystrage = web3.eth.contract(abi2).at(address2);

				// adminのインスタンス
				const admin = web3.eth.contract(abi_admin).at(address_admin);

				// venderのインスタンスを生成
				const mycontract = web3.eth.contract(abi).at(address);
				
				var account, id, program, ver;
				// ハッシュ生成
				const HASH_KEY = 'HASH_KEY';
				function generateHash (text) {
 				   const sha256 = new jsSHA('SHA-256', 'TEXT');
 				   sha256.update(text + HASH_KEY);
 				   return sha256.getHash('HEX');
				}
				// アカウントおよびネットワークに関する情報を表示
				web3.version.getNetwork((error, result) => {
                    $('#networkid').text('Network ID: '+result)
                })
  
                web3.eth.getAccounts((error, result) => {
					account = result[0]
                    $('#accounts').text('Your accounts: '+account)
                })
                mycontract.getUpInfo.call({from: account, gas:3000000},(error, result) =>{
					console.log(result)
					id = result[0];
					ver = result[1];
					$('#id').text("model: " + result[0] + " ver: " + result[1]);
					admin.searchModel(result[0], {from: account, gas:3000000},(error2, result2) =>{
								if(result2[0] == 0x0000000000000000000000000000000000000000000000000000000000000000){}
								else{
									var ghash, bhash
									document.getElementById("address").innerHTML = "アドレス: " 
									document.getElementById("address").innerHTML += result2
								}
							})
                });
                mystrage.getProgram.call('A',id-1,{from: account, gas:3000000},(error, result) =>{
                    program = result;
					$('#program').text(result)
				});

				function getVer(){
					var input = Test_form.get_ver.value
					mycontract.getVer(input, {from: account, gas:3000000},(error, result) =>{
						$('#ver').text(result)
					});
				}
				
				// ページの更新
				function reloadFunctions(){
					// アカウント・お金の更新
					web3.eth.getAccounts((error, result) => {
						if (account != result[0]){
							location.reload();
						}
						account = result[0]
    	                $('#accounts').text('Your accounts: '+account)
                	});
                    mycontract.getUpInfo.call({from: account, gas:3000000},(error, result) =>{
						console.log("id:" + id + " ver:"+ ver)
						console.log("result:"+ result)
						// 最新の情報に違いが無ければ取得しないようにしたいのに、現状常に取得しに行っている…
						if(id == result[0] && ver == result[1]){}
						else{
							id = result[0];
							ver = result[1]
							console.log("get")
							$('#id').text("model: " + result[0] + " ver: " + result[1])
							admin.searchModel(result[0], {from: account, gas:3000000},(error2, result2) =>{
								if(result2[0] == 0x0000000000000000000000000000000000000000000000000000000000000000){}
								else{
									var ghash, bhash
									document.getElementById("address").innerHTML = "アドレス: " 
									document.getElementById("address").innerHTML += result2
                            		mystrage.getProgram.call(result[0],result[1]-1,{from: account, gas:3000000},(error2, result2) =>{
                                		program = result2;
				    	        		$('#program').text(result2)
										ghash = generateHash(program)
										$('#ghash').text(ghash)
										mycontract.verify.call(ghash,result[0], {from: account, gas:3000000}, (error3, result3) => {
											$('#eq').text(result3)
										})
                           			});
								}
							})
							
                        }
                	});
				}
				setInterval('reloadFunctions()',100);
            } else {
                document.write('Install <a href="https://metamask.io">METAMASK</a>')
            }
			
		</script>
		</form>
    </body>
</html>